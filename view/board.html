<!DOCTYPE html>
<html lang="en">
<head>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
  <script>
    var Hex = fabric.util.createClass(fabric.Polygon, {
      type: 'Hex',
      initialize: function(options){
        options || (options = {});
        
        points = []
        points.push({ x: options.Xcenter +  options.size * Math.cos(.5), y: options.Ycenter +  options.size *  Math.sin(.5)})
        for (var i = 1; i <= 6;i += 1) {
          points.push({x: options.Xcenter + options.size * Math.cos((i + .5) * 2 * Math.PI / 6), y: options.Ycenter + options.size * Math.sin((i + .5) * 2 * Math.PI / 6)});
        }
        
        stone = new fabric.Circle({
          radius: 5,
          fill: 'white',
        })

        label = options.label;
        stoneLevel = options.stoneLevel;
        tileLevel = options.tileLevel;
        this.callSuper('initialize', points, options);
      },

      _render: function(ctx) {
        if(this.tileLevel === 0){this.fill = 'rgb(90,90,90)'};
        if(this.tileLevel === 1){this.fill = 'rgb(50,50,50)'};
        if(this.tileLevel === 2){this.fill = 'rgb(30,30,30)'};
        if(this.tileLevel === -1){this.fill = 'rgba(0,0,0,0)'};
        this.stroke = 'black';

        if(this.stoneLevel === 0){stone.fill = 'rgb(30,30,30)'};
        if(this.stoneLevel === 1){stone.fill = 'rgba(0,0,0,0)'};
        if(this.stoneLevel === 2){stone.fill = 'rgb(90,90,90)'};
        if(this.stoneLevel === -1){stone.fill = 'rgba(0,0,0,0'}

        this.callSuper('_render', ctx);

        stone._render(ctx);

        ctx.font = '10px Helvetica';
        ctx.fillStyle = '#FFF';
        ctx.fillText(this.label, -this.width/2, 0);
      }
    })

    function updateBoard(IBN){
      for (const place in IBN.places){
        objs[place].set('tileLevel', IBN.places[place].tile);
        objs[place].set('stoneLevel', IBN.places[place].stone);
      }
      canvas.renderAll();
    }

    function submitMove(move) {
      if(gameID === undefined) {return};
      if(move.stone.sink == undefined) {return};
      state = 'tileSource'
      document.getElementById('moveSubmit').style.color = 'black'
      socket.emit('game:playMove', {move, gameID});
    }

    let proposedMove = {
      tile: {},
      stone: {}
    };
    let state = 'tileSource'

    function placeSelected(event) {
      ({target} = event);

      if(tileSourceIsValid(target) && state === 'tileSource'){
        proposedMove.tile.source = target.label;
        target.set('tileLevel', target.tileLevel - 1);
        state = 'tileSink'
      } else if(tileSinkIsValid(target) && state === 'tileSink'){
        proposedMove.tile.sink = target.label;
        target.set('tileLevel', target.tileLevel + 1);
        state = 'stoneSource'
      } else if(stoneSourceIsValid(target) && state === 'stoneSource'){
        proposedMove.stone.source = target.label;
        target.set('stoneLevel', 1);
        state = 'stoneSink'
      } else if(stoneSinkIsValid(target) && state === 'stoneSink'){
        proposedMove.stone.sink = target.label;
        target.set('stoneLevel', IBN.turn)
        state = 'waiting'
        document.getElementById('moveSubmit').style.color = 'green';
      }
    }

    function tileSourceIsValid (target) {
      if(target.tileLevel > 0 && target.stoneLevel === 1){
        return true;
      }
      return false;
    }

    function tileSinkIsValid (target) {
      if(target.tileLevel < 2 && target.stoneLevel === 1){
        return true;
      }
      return false;
    }

    function stoneSourceIsValid (target) {
      if(target.stoneLevel === IBN.turn){
        return true;
      }
      return false;
    }

    function stoneSinkIsValid (target) {
      if(target.stoneLevel === 1 && target.tileLevel == IBN.turn && placesAreAdjacent(target.label, proposedMove.stone.source)){
        return true;
      }
      return false;
    }
    function placesAreAdjacent(placeOne, placeTwo) {
      if (adjacencyList[placeOne].includes(placeTwo)) {
        return true;
      } return false;
    }

    const adjacencyList = {
      A1: ['A2', 'A4', 'B1', 'B2'],
      A2: ['A1', 'A3', 'B2', 'B3'],
      A3: ['A2', 'A4', 'B3', 'B4'],
      A4: ['A1', 'A3', 'B4', 'B5'],
      B1: ['A1', 'B2', 'C1', 'C2'],
      B2: ['A1', 'A2', 'B1', 'B3', 'C2', 'C3'],
      B3: ['A2', 'A3', 'B2', 'B4', 'C3', 'C4'],
      B4: ['A3', 'A4', 'B3', 'B5', 'C4', 'C5'],
      B5: ['A4', 'B4', 'C5', 'C6'],
      C1: ['B1', 'C2', 'D1', 'D2'],
      C2: ['B1', 'B2', 'C1', 'C3', 'D2', 'D3'],
      C3: ['B2', 'B3', 'C2', 'C4', 'D3', 'D4'],
      C4: ['B3', 'B4', 'C3', 'C5', 'D4', 'D5'],
      C5: ['B4', 'B5', 'C4', 'C6', 'D5', 'D6'],
      C6: ['B5', 'C5', 'D6', 'D7'],
      D1: ['C1', 'D2', 'D7', 'E1'],
      D2: ['C1', 'C2', 'D1', 'D3', 'E1', 'E2'],
      D3: ['C2', 'C3', 'D2', 'D4', 'E2', 'E3'],
      D4: ['C3', 'C4', 'D3', 'D5', 'E3', 'E4'],
      D5: ['C4', 'C5', 'D4', 'D6', 'E4', 'E5'],
      D6: ['C5', 'C6', 'D5', 'D7', 'E5', 'E6'],
      D7: ['C6', 'D1', 'D6', 'E6'],
      E1: ['D1', 'D2', 'E2', 'F1'],
      E2: ['D2', 'D3', 'E1', 'E3', 'F1', 'F2'],
      E3: ['D3', 'D4', 'E2', 'E4', 'F2', 'F3'],
      E4: ['D4', 'D5', 'E3', 'E5', 'F3', 'F4'],
      E5: ['D5', 'D6', 'E4', 'E6', 'F4', 'F5'],
      E6: ['D6', 'D7', 'E5', 'F5'],
      F1: ['E1', 'E2', 'F2', 'G1'],
      F2: ['E2', 'E3', 'F1', 'F3', 'G1', 'G2'],
      F3: ['E3', 'E4', 'F2', 'F4', 'G2', 'G3'],
      F4: ['E4', 'E5', 'F3', 'F5', 'G3', 'G4'],
      F5: ['E5', 'E6', 'F4', 'G4'],
      G1: ['F1', 'F2', 'G2', 'G4'],
      G2: ['F2', 'F3', 'G1', 'G3'],
      G3: ['F3', 'F4', 'G2', 'G4'],
      G4: ['F4', 'F5', 'G1', 'G3'],
    }

    let objs = [];
    function drawBoard(options) {
      ({height} = options);
      
      R = height / 11;
      r = (Math.sqrt(3)/2) * R;

      for(i = 0; i < 7; i++){
        for(j = 0; j < 7 - Math.abs(3 - i); j++){
          x = r * (Math.abs(3 - i) + 2*j + 1)
          y = R * ((1.5 * (i+1) - .5))

          let placeConversion = {
            0: "A",
            1: "B",
            2: "C",
            3: "D", 
            4: "E",
            5: "F",
            6: "G"
          }
          let label = (() => { return placeConversion[i] + ( j + 1)})()

          objs[label] = new Hex({
                          Xcenter: x,
                          Ycenter: y,
                          size: R,
                          perPixelTargetFind: true,
                          hasControls: false,
                          hasBorders: false,
                          lockMovementX: true,
                          lockMovementY: true,
                          label: label,
                          stoneLevel: -1,
                          tileLevel: -1,
                          objectCaching: false
                        })
          

          objs[label].on('selected', function(event) {
            placeSelected(event);
          })

          canvas.add(objs[label]);
        }
      }
    };

    let canvas;
    function initializeCanvas() {
      canvas = new fabric.Canvas('canvas');

      drawBoard({height: canvas.getHeight()})
    }

    const socket = io();
    let gameID;
    let IBN;

    function joinGame() {
      document.getElementById('gameSearch').remove();
      socket.emit('game:search');
    }

    socket.on('game:create', (data) => {
      ({gameID,IBN} = data);
      console.log(data);
      updateBoard(IBN);
      document.getElementById('moves').style.display = 'block'
    })

    socket.on('move:confirm', (newIBN) => {
      IBN = newIBN;
      console.log(newIBN, objs);
      updateBoard(newIBN);
    })

  </script>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body onload="initializeCanvas()" >

  <button onmousedown="joinGame()" id="gameSearch">Game Search</button>
  <br>
  <canvas id="canvas" width="400" height="300" !display="none"></canvas>
  <br>
  <div id="moves" style="display: none;">
    <input type="button" value="Submit Move" onclick="submitMove(proposedMove)" id="moveSubmit">

  </div>

</body>
</html>